# æ˜Ÿä¹‹æ¢¦æ‰‹ä½œç®¡ç†ç³»ç»Ÿ - æ¶æ„ä¼˜åŒ–å»ºè®®

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

åŸºäºå¯¹ç°æœ‰ç³»ç»Ÿçš„æ·±å…¥åˆ†æï¼Œæœ¬æ–‡æ¡£æä¾›äº†ç³»ç»Ÿæ¶æ„ã€ä»£ç è´¨é‡ã€æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒç­‰æ–¹é¢çš„ä¼˜åŒ–å»ºè®®ï¼Œæ—¨åœ¨æå‡ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€æ‰©å±•æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## ğŸ—ï¸ æ¶æ„å±‚é¢ä¼˜åŒ–

### 1. é…ç½®ç®¡ç†ä¼˜åŒ–

#### å½“å‰é—®é¢˜
- ç¡¬ç¼–ç é…ç½®é¡¹åˆ†æ•£åœ¨å„ä¸ªæ–‡ä»¶ä¸­
- æ•°æ®åº“è¿æ¥ã€UIæ ·å¼ã€ä¸šåŠ¡è§„åˆ™ç­‰é…ç½®æ··åˆåœ¨ä»£ç ä¸­
- éš¾ä»¥è¿›è¡Œç¯å¢ƒåˆ‡æ¢å’Œé…ç½®ç®¡ç†

#### ä¼˜åŒ–æ–¹æ¡ˆ
```python
# config.py
import os
from dataclasses import dataclass
from typing import Dict, Any

@dataclass
class DatabaseConfig:
    db_path: str = "handmade_shop.db"
    backup_path: str = "backups"
    auto_backup: bool = True

@dataclass
class UIConfig:
    page_title: str = "æ˜Ÿä¹‹æ¢¦æ‰‹ä½œç®¡ç†ç³»ç»Ÿ"
    page_icon: str = "ğŸª"
    theme_colors: Dict[str, str] = None
    
    def __post_init__(self):
        if self.theme_colors is None:
            self.theme_colors = {
                "primary": "#2E86AB",
                "secondary": "#A23B72",
                "accent": "#F18F01",
                "success": "#06D6A0",
                "warning": "#FFD23F",
                "error": "#F72585"
            }

@dataclass
class BusinessConfig:
    points_per_yuan: int = 1
    low_stock_threshold: int = 5
    page_size_options: list = None
    
    def __post_init__(self):
        if self.page_size_options is None:
            self.page_size_options = [10, 20, 50]

class Config:
    def __init__(self):
        self.database = DatabaseConfig()
        self.ui = UIConfig()
        self.business = BusinessConfig()
        
    @classmethod
    def from_env(cls):
        """ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®"""
        config = cls()
        config.database.db_path = os.getenv("DB_PATH", config.database.db_path)
        config.business.points_per_yuan = int(os.getenv("POINTS_PER_YUAN", config.business.points_per_yuan))
        return config
```

### 2. æœåŠ¡å±‚æ¶æ„é‡æ„

#### å½“å‰é—®é¢˜
- ä¸šåŠ¡é€»è¾‘ä¸UIé€»è¾‘è€¦åˆ
- DatabaseManageræ‰¿æ‹…è¿‡å¤šèŒè´£
- ç¼ºå°‘ä¸šåŠ¡æœåŠ¡å±‚æŠ½è±¡

#### ä¼˜åŒ–æ–¹æ¡ˆ
```python
# services/base_service.py
from abc import ABC, abstractmethod
from typing import List, Dict, Any, Optional

class BaseService(ABC):
    def __init__(self, db_manager):
        self.db = db_manager
    
    @abstractmethod
    def validate_data(self, data: Dict[str, Any]) -> bool:
        pass

# services/customer_service.py
class CustomerService(BaseService):
    def create_customer(self, customer_data: Dict[str, Any]) -> Optional[int]:
        """åˆ›å»ºå®¢æˆ·ï¼ŒåŒ…å«ä¸šåŠ¡éªŒè¯"""
        if not self.validate_data(customer_data):
            raise ValueError("å®¢æˆ·æ•°æ®éªŒè¯å¤±è´¥")
        
        # æ£€æŸ¥æ‰‹æœºå·é‡å¤
        if self.is_phone_exists(customer_data['phone_suffix']):
            raise ValueError("æ‰‹æœºå·å·²å­˜åœ¨")
        
        return self.db.add_customer(**customer_data)
    
    def validate_data(self, data: Dict[str, Any]) -> bool:
        required_fields = ['nickname', 'phone_suffix']
        return all(field in data and data[field] for field in required_fields)
    
    def is_phone_exists(self, phone_suffix: str) -> bool:
        customers = self.db.get_customers()
        return any(c['phone_suffix'] == phone_suffix for c in customers)
    
    def update_points(self, customer_id: int, points_change: int, reason: str = ""):
        """æ›´æ–°å®¢æˆ·ç§¯åˆ†ï¼Œè®°å½•å˜æ›´åŸå› """
        # è®°å½•ç§¯åˆ†å˜æ›´å†å²
        self.db.add_points_history(customer_id, points_change, reason)
        return self.db.update_customer_points(customer_id, points_change)

# services/order_service.py
class OrderService(BaseService):
    def __init__(self, db_manager, customer_service, inventory_service):
        super().__init__(db_manager)
        self.customer_service = customer_service
        self.inventory_service = inventory_service
    
    def create_order(self, order_data: Dict[str, Any]) -> int:
        """åˆ›å»ºè®¢å•ï¼Œå¤„ç†åº“å­˜æ‰£å‡å’Œç§¯åˆ†æ›´æ–°"""
        if not self.validate_data(order_data):
            raise ValueError("è®¢å•æ•°æ®éªŒè¯å¤±è´¥")
        
        # æ£€æŸ¥åº“å­˜
        for item in order_data['items']:
            if item['type'] == 'ç°è´§':
                if not self.inventory_service.check_stock(item['inventory_id'], item['quantity']):
                    raise ValueError(f"åº“å­˜ä¸è¶³: {item['name']}")
        
        # åˆ›å»ºè®¢å•ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰
        with self.db.transaction():
            order_id = self.db.add_order(
                order_data['customer_id'],
                order_data['total_amount'],
                order_data.get('notes', ''),
                order_data.get('image_path', '')
            )
            
            # æ·»åŠ è®¢å•é¡¹å¹¶æ‰£å‡åº“å­˜
            for item in order_data['items']:
                self.db.add_order_item(order_id, **item)
                if item['type'] == 'ç°è´§':
                    self.inventory_service.reduce_stock(item['inventory_id'], item['quantity'])
            
            # æ›´æ–°å®¢æˆ·ç§¯åˆ†
            points_earned = int(order_data['total_amount'])
            self.customer_service.update_points(
                order_data['customer_id'], 
                points_earned, 
                f"è®¢å•æ”¯ä»˜ #{order_id}"
            )
        
        return order_id
```

### 3. æ•°æ®è®¿é—®å±‚ä¼˜åŒ–

#### å½“å‰é—®é¢˜
- SQLè¯­å¥åˆ†æ•£åœ¨å„ä¸ªæ–¹æ³•ä¸­
- ç¼ºå°‘è¿æ¥æ± ç®¡ç†
- æ²¡æœ‰æŸ¥è¯¢ä¼˜åŒ–æœºåˆ¶

#### ä¼˜åŒ–æ–¹æ¡ˆ
```python
# database/connection_manager.py
import sqlite3
import threading
from contextlib import contextmanager
from typing import Generator

class ConnectionManager:
    def __init__(self, db_path: str, max_connections: int = 10):
        self.db_path = db_path
        self.max_connections = max_connections
        self._local = threading.local()
    
    def get_connection(self) -> sqlite3.Connection:
        if not hasattr(self._local, 'connection'):
            self._local.connection = sqlite3.connect(
                self.db_path, 
                check_same_thread=False
            )
            self._local.connection.row_factory = sqlite3.Row
        return self._local.connection
    
    @contextmanager
    def transaction(self) -> Generator[sqlite3.Connection, None, None]:
        conn = self.get_connection()
        try:
            yield conn
            conn.commit()
        except Exception:
            conn.rollback()
            raise

# database/queries.py
class Queries:
    # å®¢æˆ·ç›¸å…³æŸ¥è¯¢
    GET_CUSTOMERS = """
        SELECT id, nickname, phone_suffix, points, notes, created_at, updated_at
        FROM customers 
        ORDER BY created_at DESC
    """
    
    GET_CUSTOMER_BY_ID = """
        SELECT * FROM customers WHERE id = ?
    """
    
    # è®¢å•ç›¸å…³æŸ¥è¯¢
    GET_ORDERS_WITH_CUSTOMER = """
        SELECT o.*, c.nickname as customer_name
        FROM orders o
        LEFT JOIN customers c ON o.customer_id = c.id
        WHERE 1=1
        {filters}
        ORDER BY o.created_at DESC
        LIMIT ? OFFSET ?
    """
    
    # åº“å­˜ç›¸å…³æŸ¥è¯¢
    GET_LOW_STOCK_ITEMS = """
        SELECT * FROM inventory 
        WHERE quantity <= ?
        ORDER BY quantity ASC
    """

# database/repository.py
class BaseRepository:
    def __init__(self, connection_manager: ConnectionManager):
        self.conn_manager = connection_manager
    
    def execute_query(self, query: str, params: tuple = ()) -> List[sqlite3.Row]:
        conn = self.conn_manager.get_connection()
        cursor = conn.cursor()
        cursor.execute(query, params)
        return cursor.fetchall()
    
    def execute_insert(self, query: str, params: tuple = ()) -> int:
        conn = self.conn_manager.get_connection()
        cursor = conn.cursor()
        cursor.execute(query, params)
        conn.commit()
        return cursor.lastrowid

class CustomerRepository(BaseRepository):
    def get_all(self) -> List[Dict]:
        rows = self.execute_query(Queries.GET_CUSTOMERS)
        return [dict(row) for row in rows]
    
    def get_by_id(self, customer_id: int) -> Optional[Dict]:
        rows = self.execute_query(Queries.GET_CUSTOMER_BY_ID, (customer_id,))
        return dict(rows[0]) if rows else None
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–
```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_customers_phone_suffix ON customers(phone_suffix);
CREATE INDEX idx_inventory_quantity ON inventory(quantity);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_orders_status_date ON orders(status, created_at);
CREATE INDEX idx_order_items_type_inventory ON order_items(item_type, inventory_id);
```

#### æŸ¥è¯¢ä¼˜åŒ–
```python
# æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
class OptimizedQueries:
    @staticmethod
    def get_orders_with_items_batch(order_ids: List[int]) -> Dict:
        """æ‰¹é‡è·å–è®¢å•åŠå…¶å•†å“ä¿¡æ¯"""
        placeholders = ','.join(['?' for _ in order_ids])
        query = f"""
            SELECT 
                o.*,
                c.nickname as customer_name,
                oi.id as item_id,
                oi.item_type,
                oi.quantity,
                oi.unit_price,
                i.product_name as inventory_name,
                bt.name as bag_type_name,
                f1.name as outer_fabric_name,
                f2.name as inner_fabric_name
            FROM orders o
            LEFT JOIN customers c ON o.customer_id = c.id
            LEFT JOIN order_items oi ON o.id = oi.order_id
            LEFT JOIN inventory i ON oi.inventory_id = i.id
            LEFT JOIN bag_types bt ON oi.bag_type_id = bt.id
            LEFT JOIN fabrics f1 ON oi.outer_fabric_id = f1.id
            LEFT JOIN fabrics f2 ON oi.inner_fabric_id = f2.id
            WHERE o.id IN ({placeholders})
            ORDER BY o.id, oi.id
        """
        return query, order_ids
```

### 2. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

#### å¤šå±‚ç¼“å­˜æ¶æ„
```python
# cache/cache_manager.py
import time
from typing import Any, Optional, Dict
from functools import wraps

class CacheManager:
    def __init__(self):
        self._cache: Dict[str, Dict] = {}
        self._ttl: Dict[str, float] = {}
    
    def get(self, key: str) -> Optional[Any]:
        if key in self._cache:
            if key in self._ttl and time.time() > self._ttl[key]:
                del self._cache[key]
                del self._ttl[key]
                return None
            return self._cache[key]['data']
        return None
    
    def set(self, key: str, value: Any, ttl: int = 300):
        self._cache[key] = {'data': value}
        if ttl > 0:
            self._ttl[key] = time.time() + ttl
    
    def invalidate(self, pattern: str = None):
        if pattern:
            keys_to_remove = [k for k in self._cache.keys() if pattern in k]
            for key in keys_to_remove:
                self._cache.pop(key, None)
                self._ttl.pop(key, None)
        else:
            self._cache.clear()
            self._ttl.clear()

def cached(ttl: int = 300, key_prefix: str = ""):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            cache_key = f"{key_prefix}:{func.__name__}:{hash(str(args) + str(kwargs))}"
            
            # å°è¯•ä»ç¼“å­˜è·å–
            cached_result = cache_manager.get(cache_key)
            if cached_result is not None:
                return cached_result
            
            # æ‰§è¡Œå‡½æ•°å¹¶ç¼“å­˜ç»“æœ
            result = func(*args, **kwargs)
            cache_manager.set(cache_key, result, ttl)
            return result
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
cache_manager = CacheManager()

class CustomerService:
    @cached(ttl=600, key_prefix="customers")
    def get_customers(self):
        return self.db.get_customers()
    
    def update_customer(self, customer_id: int, **kwargs):
        result = self.db.update_customer(customer_id, **kwargs)
        # æ¸…é™¤ç›¸å…³ç¼“å­˜
        cache_manager.invalidate("customers")
        return result
```

### 3. å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### ç»„ä»¶æ‡’åŠ è½½
```python
# ui/lazy_components.py
import streamlit as st
from typing import Callable, Any

class LazyComponent:
    def __init__(self, loader: Callable, *args, **kwargs):
        self.loader = loader
        self.args = args
        self.kwargs = kwargs
        self._loaded = False
        self._component = None
    
    def render(self):
        if not self._loaded:
            with st.spinner("åŠ è½½ä¸­..."):
                self._component = self.loader(*self.args, **self.kwargs)
                self._loaded = True
        return self._component

# ä½¿ç”¨ç¤ºä¾‹
def load_order_chart():
    # å¤æ‚çš„å›¾è¡¨ç”Ÿæˆé€»è¾‘
    orders = get_orders()
    return create_order_trend_chart(orders)

# åœ¨é¡µé¢ä¸­ä½¿ç”¨
if st.button("æ˜¾ç¤ºè®¢å•è¶‹åŠ¿"):
    chart_component = LazyComponent(load_order_chart)
    chart_component.render()
```

## ğŸ”§ ä»£ç è´¨é‡ä¼˜åŒ–

### 1. é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ

#### ç»Ÿä¸€å¼‚å¸¸å¤„ç†
```python
# exceptions.py
class BusinessException(Exception):
    def __init__(self, message: str, error_code: str = None):
        self.message = message
        self.error_code = error_code
        super().__init__(self.message)

class ValidationError(BusinessException):
    pass

class InsufficientStockError(BusinessException):
    pass

class CustomerNotFoundError(BusinessException):
    pass

# logging_config.py
import logging
import sys
from datetime import datetime

def setup_logging():
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        handlers=[
            logging.FileHandler(f'logs/app_{datetime.now().strftime("%Y%m%d")}.log'),
            logging.StreamHandler(sys.stdout)
        ]
    )

# ä½¿ç”¨è£…é¥°å™¨ç»Ÿä¸€å¤„ç†å¼‚å¸¸
def handle_exceptions(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except BusinessException as e:
            logging.error(f"ä¸šåŠ¡å¼‚å¸¸: {e.message}")
            st.error(f"æ“ä½œå¤±è´¥: {e.message}")
        except Exception as e:
            logging.exception(f"ç³»ç»Ÿå¼‚å¸¸: {str(e)}")
            st.error("ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜")
    return wrapper
```

### 2. æ•°æ®éªŒè¯æ¡†æ¶

#### Pydanticæ¨¡å‹éªŒè¯
```python
# models/validators.py
from pydantic import BaseModel, validator, Field
from typing import Optional, List
from datetime import datetime

class CustomerModel(BaseModel):
    nickname: str = Field(..., min_length=1, max_length=50)
    phone_suffix: str = Field(..., regex=r'^\d{4}$')
    points: int = Field(default=0, ge=0)
    notes: Optional[str] = Field(None, max_length=500)
    
    @validator('nickname')
    def nickname_must_not_be_empty(cls, v):
        if not v.strip():
            raise ValueError('å®¢æˆ·æ˜µç§°ä¸èƒ½ä¸ºç©º')
        return v.strip()

class OrderItemModel(BaseModel):
    item_type: str = Field(..., regex=r'^(ç°è´§|å®šåˆ¶)$')
    quantity: int = Field(..., gt=0)
    unit_price: float = Field(..., gt=0)
    inventory_id: Optional[int] = None
    bag_type_id: Optional[int] = None
    outer_fabric_id: Optional[int] = None
    inner_fabric_id: Optional[int] = None
    notes: Optional[str] = None
    
    @validator('inventory_id')
    def validate_inventory_for_stock_item(cls, v, values):
        if values.get('item_type') == 'ç°è´§' and v is None:
            raise ValueError('ç°è´§å•†å“å¿…é¡»æŒ‡å®šåº“å­˜ID')
        return v
    
    @validator('bag_type_id')
    def validate_bag_type_for_custom_item(cls, v, values):
        if values.get('item_type') == 'å®šåˆ¶' and v is None:
            raise ValueError('å®šåˆ¶å•†å“å¿…é¡»æŒ‡å®šåŒ…å‹ID')
        return v

class OrderModel(BaseModel):
    customer_id: int = Field(..., gt=0)
    items: List[OrderItemModel] = Field(..., min_items=1)
    notes: Optional[str] = Field(None, max_length=1000)
    image_path: Optional[str] = None
    
    @property
    def total_amount(self) -> float:
        return sum(item.quantity * item.unit_price for item in self.items)
```

### 3. å•å…ƒæµ‹è¯•æ¡†æ¶

#### æµ‹è¯•ç»“æ„
```python
# tests/test_customer_service.py
import pytest
from unittest.mock import Mock, patch
from services.customer_service import CustomerService
from exceptions import ValidationError

class TestCustomerService:
    def setup_method(self):
        self.mock_db = Mock()
        self.customer_service = CustomerService(self.mock_db)
    
    def test_create_customer_success(self):
        # å‡†å¤‡æµ‹è¯•æ•°æ®
        customer_data = {
            'nickname': 'æµ‹è¯•å®¢æˆ·',
            'phone_suffix': '1234',
            'points': 0,
            'notes': 'æµ‹è¯•å¤‡æ³¨'
        }
        
        # æ¨¡æ‹Ÿæ•°æ®åº“è¿”å›
        self.mock_db.add_customer.return_value = 1
        self.mock_db.get_customers.return_value = []
        
        # æ‰§è¡Œæµ‹è¯•
        result = self.customer_service.create_customer(customer_data)
        
        # éªŒè¯ç»“æœ
        assert result == 1
        self.mock_db.add_customer.assert_called_once_with(**customer_data)
    
    def test_create_customer_duplicate_phone(self):
        # å‡†å¤‡æµ‹è¯•æ•°æ®
        customer_data = {
            'nickname': 'æµ‹è¯•å®¢æˆ·',
            'phone_suffix': '1234'
        }
        
        # æ¨¡æ‹Ÿå·²å­˜åœ¨çš„å®¢æˆ·
        self.mock_db.get_customers.return_value = [
            {'phone_suffix': '1234'}
        ]
        
        # æ‰§è¡Œæµ‹è¯•å¹¶éªŒè¯å¼‚å¸¸
        with pytest.raises(ValueError, match="æ‰‹æœºå·å·²å­˜åœ¨"):
            self.customer_service.create_customer(customer_data)

# tests/conftest.py
import pytest
import tempfile
import os
from database import DatabaseManager

@pytest.fixture
def temp_db():
    """åˆ›å»ºä¸´æ—¶æ•°æ®åº“ç”¨äºæµ‹è¯•"""
    temp_file = tempfile.NamedTemporaryFile(delete=False)
    temp_file.close()
    
    db = DatabaseManager(temp_file.name)
    yield db
    
    os.unlink(temp_file.name)
```

## ğŸ¨ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. å“åº”å¼è®¾è®¡æ”¹è¿›

#### ç§»åŠ¨ç«¯é€‚é…
```python
# ui/responsive.py
import streamlit as st

class ResponsiveLayout:
    @staticmethod
    def get_columns_config():
        """æ ¹æ®å±å¹•å°ºå¯¸è¿”å›åˆ—é…ç½®"""
        # æ£€æµ‹è®¾å¤‡ç±»å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
        if st.session_state.get('mobile_device', False):
            return [1]  # ç§»åŠ¨ç«¯å•åˆ—
        else:
            return [1, 1, 1, 1]  # æ¡Œé¢ç«¯å››åˆ—
    
    @staticmethod
    def adaptive_columns(*ratios):
        """è‡ªé€‚åº”åˆ—å¸ƒå±€"""
        if len(ratios) > 2 and st.session_state.get('mobile_device', False):
            # ç§»åŠ¨ç«¯å¼ºåˆ¶å•åˆ—
            return [st.container() for _ in range(len(ratios))]
        else:
            return st.columns(ratios)

# ä½¿ç”¨ç¤ºä¾‹
def render_dashboard():
    cols = ResponsiveLayout.adaptive_columns(1, 1, 1, 1)
    
    with cols[0]:
        create_metric_card("å®¢æˆ·æ€»æ•°", "100")
    with cols[1]:
        create_metric_card("è®¢å•æ€»æ•°", "50")
    # ...
```

### 2. äº¤äº’ä½“éªŒä¼˜åŒ–

#### æ“ä½œç¡®è®¤å’Œåé¦ˆ
```python
# ui/feedback.py
import streamlit as st
from typing import Callable, Any

class FeedbackManager:
    @staticmethod
    def confirm_action(message: str, action: Callable, *args, **kwargs) -> Any:
        """ç¡®è®¤æ“ä½œå¯¹è¯æ¡†"""
        if f"confirm_{hash(message)}" not in st.session_state:
            st.session_state[f"confirm_{hash(message)}"] = False
        
        if not st.session_state[f"confirm_{hash(message)}"]:
            st.warning(message)
            col1, col2 = st.columns(2)
            with col1:
                if st.button("ç¡®è®¤", key=f"confirm_yes_{hash(message)}"):
                    st.session_state[f"confirm_{hash(message)}"] = True
                    st.rerun()
            with col2:
                if st.button("å–æ¶ˆ", key=f"confirm_no_{hash(message)}"):
                    return None
        else:
            # æ‰§è¡Œæ“ä½œ
            try:
                result = action(*args, **kwargs)
                st.success("æ“ä½œæˆåŠŸå®Œæˆ")
                st.session_state[f"confirm_{hash(message)}"] = False
                return result
            except Exception as e:
                st.error(f"æ“ä½œå¤±è´¥: {str(e)}")
                st.session_state[f"confirm_{hash(message)}"] = False
                return None

    @staticmethod
    def progress_action(message: str, action: Callable, steps: int = 100) -> Any:
        """å¸¦è¿›åº¦æ¡çš„æ“ä½œ"""
        progress_bar = st.progress(0)
        status_text = st.empty()
        
        try:
            for i in range(steps):
                progress_bar.progress((i + 1) / steps)
                status_text.text(f"{message}... {i+1}/{steps}")
                # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ­¥éª¤é€»è¾‘
            
            result = action()
            status_text.text("æ“ä½œå®Œæˆ!")
            return result
        except Exception as e:
            status_text.text(f"æ“ä½œå¤±è´¥: {str(e)}")
            raise
```

### 3. æ•°æ®å¯è§†åŒ–å¢å¼º

#### äº¤äº’å¼å›¾è¡¨
```python
# visualization/charts.py
import plotly.graph_objects as go
import plotly.express as px
from typing import List, Dict

class EnhancedCharts:
    @staticmethod
    def create_interactive_order_trend(orders: List[Dict]):
        """åˆ›å»ºäº¤äº’å¼è®¢å•è¶‹åŠ¿å›¾"""
        df = pd.DataFrame(orders)
        df['created_at'] = pd.to_datetime(df['created_at'])
        df['date'] = df['created_at'].dt.date
        
        daily_stats = df.groupby('date').agg({
            'id': 'count',
            'total_amount': 'sum'
        }).reset_index()
        
        fig = go.Figure()
        
        # æ·»åŠ è®¢å•æ•°é‡çº¿
        fig.add_trace(go.Scatter(
            x=daily_stats['date'],
            y=daily_stats['id'],
            mode='lines+markers',
            name='è®¢å•æ•°é‡',
            line=dict(color='#2E86AB', width=3),
            hovertemplate='æ—¥æœŸ: %{x}<br>è®¢å•æ•°é‡: %{y}<extra></extra>'
        ))
        
        # æ·»åŠ é”€å”®é¢çº¿ï¼ˆæ¬¡åæ ‡è½´ï¼‰
        fig.add_trace(go.Scatter(
            x=daily_stats['date'],
            y=daily_stats['total_amount'],
            mode='lines+markers',
            name='é”€å”®é¢',
            yaxis='y2',
            line=dict(color='#A23B72', width=3),
            hovertemplate='æ—¥æœŸ: %{x}<br>é”€å”®é¢: Â¥%{y:.2f}<extra></extra>'
        ))
        
        # æ›´æ–°å¸ƒå±€
        fig.update_layout(
            title='è®¢å•è¶‹åŠ¿åˆ†æ',
            xaxis_title='æ—¥æœŸ',
            yaxis=dict(title='è®¢å•æ•°é‡', side='left'),
            yaxis2=dict(title='é”€å”®é¢ (Â¥)', side='right', overlaying='y'),
            hovermode='x unified',
            template='plotly_white'
        )
        
        return fig
    
    @staticmethod
    def create_customer_analysis_chart(customers: List[Dict]):
        """åˆ›å»ºå®¢æˆ·åˆ†æå›¾è¡¨"""
        df = pd.DataFrame(customers)
        
        # ç§¯åˆ†åˆ†å¸ƒ
        fig_points = px.histogram(
            df, 
            x='points', 
            nbins=20,
            title='å®¢æˆ·ç§¯åˆ†åˆ†å¸ƒ',
            labels={'points': 'ç§¯åˆ†', 'count': 'å®¢æˆ·æ•°é‡'}
        )
        
        return fig_points
```

## ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–

### 1. PWAæ”¯æŒ
```python
# pwa/manifest.py
def generate_pwa_manifest():
    return {
        "name": "æ˜Ÿä¹‹æ¢¦æ‰‹ä½œç®¡ç†ç³»ç»Ÿ",
        "short_name": "æ˜Ÿä¹‹æ¢¦",
        "description": "æ‰‹ä½œä¸šåŠ¡ç®¡ç†ç³»ç»Ÿ",
        "start_url": "/",
        "display": "standalone",
        "background_color": "#ffffff",
        "theme_color": "#2E86AB",
        "icons": [
            {
                "src": "static/icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
            },
            {
                "src": "static/icon-512.png",
                "sizes": "512x512",
                "type": "image/png"
            }
        ]
    }
```

### 2. ç¦»çº¿æ”¯æŒ
```python
# offline/cache_strategy.py
class OfflineManager:
    def __init__(self):
        self.offline_data = {}
    
    def cache_critical_data(self):
        """ç¼“å­˜å…³é”®æ•°æ®ä»¥æ”¯æŒç¦»çº¿ä½¿ç”¨"""
        self.offline_data = {
            'customers': self.get_customers(),
            'inventory': self.get_inventory_items(),
            'bag_types': self.get_bag_types(),
            'fabrics': self.get_fabrics()
        }
    
    def sync_when_online(self):
        """ç½‘ç»œæ¢å¤æ—¶åŒæ­¥æ•°æ®"""
        # å®ç°æ•°æ®åŒæ­¥é€»è¾‘
        pass
```

## ğŸ”’ å®‰å…¨æ€§å¢å¼º

### 1. æ•°æ®åŠ å¯†
```python
# security/encryption.py
import hashlib
import secrets
from cryptography.fernet import Fernet

class DataEncryption:
    def __init__(self):
        self.key = self._get_or_create_key()
        self.cipher = Fernet(self.key)
    
    def _get_or_create_key(self):
        """è·å–æˆ–åˆ›å»ºåŠ å¯†å¯†é’¥"""
        key_file = "config/encryption.key"
        try:
            with open(key_file, 'rb') as f:
                return f.read()
        except FileNotFoundError:
            key = Fernet.generate_key()
            with open(key_file, 'wb') as f:
                f.write(key)
            return key
    
    def encrypt_sensitive_data(self, data: str) -> str:
        """åŠ å¯†æ•æ„Ÿæ•°æ®"""
        return self.cipher.encrypt(data.encode()).decode()
    
    def decrypt_sensitive_data(self, encrypted_data: str) -> str:
        """è§£å¯†æ•æ„Ÿæ•°æ®"""
        return self.cipher.decrypt(encrypted_data.encode()).decode()
```

### 2. è®¿é—®æ§åˆ¶
```python
# security/auth.py
import streamlit as st
from typing import Optional

class SimpleAuth:
    def __init__(self, password_hash: str):
        self.password_hash = password_hash
    
    def authenticate(self, password: str) -> bool:
        """ç®€å•å¯†ç éªŒè¯"""
        return hashlib.sha256(password.encode()).hexdigest() == self.password_hash
    
    def require_auth(self):
        """è¦æ±‚ç”¨æˆ·è®¤è¯"""
        if 'authenticated' not in st.session_state:
            st.session_state.authenticated = False
        
        if not st.session_state.authenticated:
            st.title("ğŸ” ç³»ç»Ÿç™»å½•")
            password = st.text_input("è¯·è¾“å…¥å¯†ç ", type="password")
            
            if st.button("ç™»å½•"):
                if self.authenticate(password):
                    st.session_state.authenticated = True
                    st.success("ç™»å½•æˆåŠŸ!")
                    st.rerun()
                else:
                    st.error("å¯†ç é”™è¯¯!")
            
            st.stop()
```

## ğŸ“Š ç›‘æ§å’Œåˆ†æ

### 1. æ€§èƒ½ç›‘æ§
```python
# monitoring/performance.py
import time
import functools
from typing import Dict, List

class PerformanceMonitor:
    def __init__(self):
        self.metrics: Dict[str, List[float]] = {}
    
    def measure_time(self, func_name: str = None):
        """æ€§èƒ½æµ‹é‡è£…é¥°å™¨"""
        def decorator(func):
            @functools.wraps(func)
            def wrapper(*args, **kwargs):
                start_time = time.time()
                result = func(*args, **kwargs)
                end_time = time.time()
                
                execution_time = end_time - start_time
                metric_name = func_name or func.__name__
                
                if metric_name not in self.metrics:
                    self.metrics[metric_name] = []
                
                self.metrics[metric_name].append(execution_time)
                
                # è®°å½•æ…¢æŸ¥è¯¢
                if execution_time > 1.0:  # è¶…è¿‡1ç§’
                    logging.warning(f"æ…¢æ“ä½œæ£€æµ‹: {metric_name} è€—æ—¶ {execution_time:.2f}ç§’")
                
                return result
            return wrapper
        return decorator
    
    def get_performance_report(self) -> Dict:
        """è·å–æ€§èƒ½æŠ¥å‘Š"""
        report = {}
        for func_name, times in self.metrics.items():
            report[func_name] = {
                'count': len(times),
                'avg_time': sum(times) / len(times),
                'max_time': max(times),
                'min_time': min(times)
            }
        return report
```

### 2. ä¸šåŠ¡åˆ†æ
```python
# analytics/business_analytics.py
class BusinessAnalytics:
    def __init__(self, db_manager):
        self.db = db_manager
    
    def get_customer_insights(self) -> Dict:
        """å®¢æˆ·æ´å¯Ÿåˆ†æ"""
        customers = self.db.get_customers()
        orders = self.db.get_orders()
        
        # å®¢æˆ·ä»·å€¼åˆ†æ
        customer_value = {}
        for order in orders:
            customer_id = order['customer_id']
            if customer_id not in customer_value:
                customer_value[customer_id] = 0
            customer_value[customer_id] += order['total_amount']
        
        # å®¢æˆ·åˆ†å±‚
        high_value = [cid for cid, value in customer_value.items() if value > 1000]
        medium_value = [cid for cid, value in customer_value.items() if 500 <= value <= 1000]
        low_value = [cid for cid, value in customer_value.items() if value < 500]
        
        return {
            'total_customers': len(customers),
            'high_value_customers': len(high_value),
            'medium_value_customers': len(medium_value),
            'low_value_customers': len(low_value),
            'avg_customer_value': sum(customer_value.values()) / len(customer_value) if customer_value else 0
        }
    
    def get_product_insights(self) -> Dict:
        """äº§å“æ´å¯Ÿåˆ†æ"""
        # å®ç°äº§å“é”€å”®åˆ†æ
        pass
    
    def get_trend_analysis(self) -> Dict:
        """è¶‹åŠ¿åˆ†æ"""
        # å®ç°è¶‹åŠ¿åˆ†æ
        pass
```

## ğŸš€ éƒ¨ç½²å’Œè¿ç»´ä¼˜åŒ–

### 1. DockeråŒ–éƒ¨ç½²
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8501

HEALTHCHECK CMD curl --fail http://localhost:8501/_stcore/health

CMD ["streamlit", "run", "main.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data
      - ./backups:/app/backups
    environment:
      - DB_PATH=/app/data/handmade_shop.db
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - app
    restart: unless-stopped
```

### 2. è‡ªåŠ¨åŒ–è¿ç»´
```python
# ops/health_check.py
import requests
import time
import logging

class HealthChecker:
    def __init__(self, app_url: str):
        self.app_url = app_url
    
    def check_health(self) -> bool:
        """å¥åº·æ£€æŸ¥"""
        try:
            response = requests.get(f"{self.app_url}/_stcore/health", timeout=5)
            return response.status_code == 200
        except Exception as e:
            logging.error(f"å¥åº·æ£€æŸ¥å¤±è´¥: {e}")
            return False
    
    def monitor_continuously(self, interval: int = 60):
        """æŒç»­ç›‘æ§"""
        while True:
            if not self.check_health():
                logging.error("åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥")
                # å‘é€å‘Šè­¦é€šçŸ¥
                self.send_alert()
            
            time.sleep(interval)
    
    def send_alert(self):
        """å‘é€å‘Šè­¦"""
        # å®ç°å‘Šè­¦é€»è¾‘ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰ï¼‰
        pass
```

## ğŸ“‹ å®æ–½å»ºè®®

### ä¼˜å…ˆçº§æ’åº
1. **é«˜ä¼˜å…ˆçº§**
   - é…ç½®ç®¡ç†ä¼˜åŒ–
   - æœåŠ¡å±‚æ¶æ„é‡æ„
   - æ•°æ®éªŒè¯æ¡†æ¶
   - é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ

2. **ä¸­ä¼˜å…ˆçº§**
   - æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€ç´¢å¼•ï¼‰
   - å•å…ƒæµ‹è¯•æ¡†æ¶
   - ç”¨æˆ·ä½“éªŒä¼˜åŒ–
   - å®‰å…¨æ€§å¢å¼º

3. **ä½ä¼˜å…ˆçº§**
   - PWAæ”¯æŒ
   - é«˜çº§åˆ†æåŠŸèƒ½
   - DockeråŒ–éƒ¨ç½²
   - è‡ªåŠ¨åŒ–è¿ç»´

### å®æ–½æ­¥éª¤
1. **ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰**: é…ç½®ç®¡ç†å’ŒæœåŠ¡å±‚é‡æ„
2. **ç¬¬äºŒé˜¶æ®µï¼ˆ2-3å‘¨ï¼‰**: æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†
3. **ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4å‘¨ï¼‰**: æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•æ¡†æ¶
4. **ç¬¬å››é˜¶æ®µï¼ˆ4-6å‘¨ï¼‰**: ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§ä¼˜åŒ–
5. **ç¬¬äº”é˜¶æ®µï¼ˆ6-8å‘¨ï¼‰**: éƒ¨ç½²å’Œè¿ç»´ä¼˜åŒ–

### é£é™©è¯„ä¼°
- **æŠ€æœ¯é£é™©**: é‡æ„å¯èƒ½å¼•å…¥æ–°çš„bugï¼Œå»ºè®®åˆ†æ­¥å®æ–½
- **ä¸šåŠ¡é£é™©**: ä¼˜åŒ–æœŸé—´å¯èƒ½å½±å“æ­£å¸¸ä½¿ç”¨ï¼Œå»ºè®®åœ¨ä½å³°æœŸè¿›è¡Œ
- **èµ„æºé£é™©**: éœ€è¦æŠ•å…¥é¢å¤–çš„å¼€å‘å’Œæµ‹è¯•æ—¶é—´

## ğŸ¯ æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–å»ºè®®çš„å®æ–½ï¼Œç³»ç»Ÿå°†åœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°æ˜¾è‘—æå‡ï¼š

1. **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„æ¶æ„åˆ†å±‚å’Œæ¨¡å—åŒ–è®¾è®¡
2. **å¯æ‰©å±•æ€§**: çµæ´»çš„é…ç½®ç®¡ç†å’ŒæœåŠ¡åŒ–æ¶æ„
3. **æ€§èƒ½**: å¤šå±‚ç¼“å­˜å’Œæ•°æ®åº“ä¼˜åŒ–
4. **ç”¨æˆ·ä½“éªŒ**: å“åº”å¼è®¾è®¡å’Œäº¤äº’ä¼˜åŒ–
5. **å®‰å…¨æ€§**: æ•°æ®åŠ å¯†å’Œè®¿é—®æ§åˆ¶
6. **ç¨³å®šæ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç›‘æ§æœºåˆ¶

å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½è¿™äº›ä¼˜åŒ–æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿåœ¨ä¿æŒç¨³å®šè¿è¡Œçš„åŒæ—¶ä¸æ–­æ”¹è¿›å’Œå®Œå–„ã€‚