# 智能待办事项管理系统 - 部署指南

## 目录
1. [项目概述](#项目概述)
2. [本地开发环境](#本地开发环境)
3. [生产环境部署](#生产环境部署)
4. [云平台部署选项](#云平台部署选项)
5. [域名和SSL配置](#域名和ssl配置)
6. [数据库配置](#数据库配置)
7. [监控和维护](#监控和维护)
8. [故障排除](#故障排除)

## 项目概述

这是一个基于Flask的智能待办事项管理系统，具有以下特性：
- 任务创建、编辑、删除
- 任务分类管理
- 优先级设置
- 开始日期和截止日期
- 拖拽排序
- 批量操作
- 搜索和过滤
- 响应式设计

## 本地开发环境

### 系统要求
- Python 3.8+
- pip (Python包管理器)
- Git

### 安装步骤
1. 克隆项目
```bash
git clone <your-repository-url>
cd My_Todo
```

2. 创建虚拟环境
```bash
python -m venv venv
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate
```

3. 安装依赖
```bash
pip install -r requirements.txt
```

4. 初始化数据库
```bash
python -c "from app import app, db; app.app_context().push(); db.create_all()"
```

5. 运行应用
```bash
python app.py
```

访问 http://127.0.0.1:5000 查看应用

## 生产环境部署

### 方案一：使用Gunicorn + Nginx (推荐)

#### 1. 服务器准备
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install python3 python3-pip python3-venv nginx git -y
```

#### 2. 部署应用
```bash
# 创建应用目录
sudo mkdir -p /var/www/todo-app
cd /var/www/todo-app

# 克隆代码
sudo git clone <your-repository-url> .

# 创建虚拟环境
sudo python3 -m venv venv
sudo chown -R www-data:www-data /var/www/todo-app

# 激活虚拟环境并安装依赖
sudo -u www-data /var/www/todo-app/venv/bin/pip install -r requirements.txt
sudo -u www-data /var/www/todo-app/venv/bin/pip install gunicorn
```

#### 3. 创建Gunicorn配置
创建 `/var/www/todo-app/gunicorn.conf.py`:
```python
bind = "127.0.0.1:8000"
workers = 4
worker_class = "sync"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100
timeout = 30
keepalive = 2
user = "www-data"
group = "www-data"
tmp_upload_dir = None
errorlog = "/var/log/gunicorn/error.log"
accesslog = "/var/log/gunicorn/access.log"
loglevel = "info"
```

#### 4. 创建systemd服务
创建 `/etc/systemd/system/todo-app.service`:
```ini
[Unit]
Description=Todo App Gunicorn daemon
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/todo-app
Environment="PATH=/var/www/todo-app/venv/bin"
ExecStart=/var/www/todo-app/venv/bin/gunicorn --config gunicorn.conf.py app:app
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 5. 配置Nginx
创建 `/etc/nginx/sites-available/todo-app`:
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static/ {
        alias /var/www/todo-app/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 6. 启动服务
```bash
# 创建日志目录
sudo mkdir -p /var/log/gunicorn
sudo chown www-data:www-data /var/log/gunicorn

# 启用并启动服务
sudo systemctl enable todo-app
sudo systemctl start todo-app

# 配置Nginx
sudo ln -s /etc/nginx/sites-available/todo-app /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 方案二：使用Docker部署

#### 1. 创建Dockerfile
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

RUN python -c "from app import app, db; app.app_context().push(); db.create_all()"

EXPOSE 5000

CMD ["gunicorn", "--bind", "0.0.0.0:5000", "app:app"]
```

#### 2. 创建docker-compose.yml
```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./instance:/app/instance
    environment:
      - FLASK_ENV=production
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
    restart: unless-stopped
```

#### 3. 部署命令
```bash
docker-compose up -d
```

## 云平台部署选项

### 1. Heroku (最简单)

#### 准备文件
创建 `Procfile`:
```
web: gunicorn app:app
```

创建 `runtime.txt`:
```
python-3.9.18
```

#### 部署步骤
```bash
# 安装Heroku CLI
# 登录Heroku
heroku login

# 创建应用
heroku create your-app-name

# 设置环境变量
heroku config:set FLASK_ENV=production

# 部署
git add .
git commit -m "Deploy to Heroku"
git push heroku main
```

### 2. DigitalOcean App Platform

1. 连接GitHub仓库
2. 选择Python应用
3. 设置构建命令：`pip install -r requirements.txt`
4. 设置运行命令：`gunicorn --worker-tmp-dir /dev/shm app:app`
5. 配置环境变量

### 3. AWS Elastic Beanstalk

1. 安装EB CLI
2. 初始化：`eb init`
3. 创建环境：`eb create production`
4. 部署：`eb deploy`

### 4. Google Cloud Run

```bash
# 构建镜像
gcloud builds submit --tag gcr.io/PROJECT-ID/todo-app

# 部署
gcloud run deploy --image gcr.io/PROJECT-ID/todo-app --platform managed
```

## 域名和SSL配置

### 1. 购买域名
推荐域名注册商：
- Namecheap
- GoDaddy
- 阿里云
- 腾讯云

### 2. DNS配置
将域名指向服务器IP：
```
A记录: @ -> 你的服务器IP
A记录: www -> 你的服务器IP
```

### 3. SSL证书配置 (Let's Encrypt)

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取SSL证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

## 数据库配置

### SQLite (默认，适合小型应用)
无需额外配置，数据存储在 `instance/tasks.db`

### PostgreSQL (推荐生产环境)

#### 1. 安装PostgreSQL
```bash
sudo apt install postgresql postgresql-contrib -y
```

#### 2. 创建数据库和用户
```bash
sudo -u postgres psql
CREATE DATABASE todoapp;
CREATE USER todouser WITH PASSWORD 'your-password';
GRANT ALL PRIVILEGES ON DATABASE todoapp TO todouser;
\q
```

#### 3. 修改应用配置
在 `app.py` 中添加：
```python
import os

# 数据库配置
if os.environ.get('DATABASE_URL'):
    app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get('DATABASE_URL')
else:
    app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///tasks.db'
```

#### 4. 设置环境变量
```bash
export DATABASE_URL="postgresql://todouser:your-password@localhost/todoapp"
```

### MySQL配置
```python
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://username:password@localhost/todoapp'
```

## 监控和维护

### 1. 日志监控
```bash
# 查看应用日志
sudo journalctl -u todo-app -f

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 2. 性能监控
推荐工具：
- New Relic
- Datadog
- Prometheus + Grafana

### 3. 备份策略
```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
cp /var/www/todo-app/instance/tasks.db /backup/tasks_$DATE.db

# 添加到crontab
0 2 * * * /path/to/backup-script.sh
```

### 4. 更新部署
```bash
# 拉取最新代码
cd /var/www/todo-app
sudo -u www-data git pull

# 重启服务
sudo systemctl restart todo-app
```

## 故障排除

### 常见问题

#### 1. 应用无法启动
```bash
# 检查服务状态
sudo systemctl status todo-app

# 查看详细日志
sudo journalctl -u todo-app -n 50
```

#### 2. 数据库连接错误
- 检查数据库服务是否运行
- 验证连接字符串
- 检查用户权限

#### 3. 静态文件无法加载
- 检查Nginx配置
- 验证文件路径和权限

#### 4. 502 Bad Gateway
- 检查Gunicorn是否运行
- 验证端口配置
- 检查防火墙设置

### 性能优化

#### 1. 数据库优化
```python
# 添加数据库索引
class Task(db.Model):
    # ... 其他字段
    created_at = db.Column(db.DateTime, default=datetime.utcnow, index=True)
    completed = db.Column(db.Boolean, default=False, index=True)
```

#### 2. 缓存配置
```python
from flask_caching import Cache

cache = Cache(app, config={'CACHE_TYPE': 'simple'})

@app.route('/api/stats')
@cache.cached(timeout=300)  # 缓存5分钟
def get_stats():
    # ... 统计逻辑
```

#### 3. 静态文件CDN
使用CloudFlare或AWS CloudFront加速静态文件访问。

## 安全建议

1. **环境变量**：敏感信息使用环境变量
2. **HTTPS**：强制使用SSL
3. **防火墙**：只开放必要端口
4. **定期更新**：保持系统和依赖包更新
5. **备份**：定期备份数据
6. **监控**：设置异常告警

## 成本估算

### 基础VPS方案 (推荐新手)
- DigitalOcean Droplet: $5-10/月
- 域名: $10-15/年
- 总成本: ~$70-135/年

### 云平台方案
- Heroku: $7/月 (Hobby tier)
- Vercel: 免费 (个人项目)
- Railway: $5/月

选择建议：
- **学习/个人项目**：Heroku免费层或Vercel
- **小型商业项目**：DigitalOcean VPS
- **企业级应用**：AWS/GCP/Azure

## 联系支持

如果在部署过程中遇到问题，可以：
1. 查看项目GitHub Issues
2. 参考Flask官方文档
3. 搜索相关技术社区

祝您部署成功！🎉